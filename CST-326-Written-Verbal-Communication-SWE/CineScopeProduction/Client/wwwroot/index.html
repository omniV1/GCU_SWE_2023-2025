<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character encoding and viewport settings -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Page title and base URL -->
    <title>CineScope</title>
    <base href="/" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="manifest" href="manifest.json">

    <!-- Styles: Critical styles first -->
    <link href="css/app.css" rel="stylesheet" />
    <link href="css/loading-animation.css" rel="stylesheet" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />

    <!-- MudBlazor Styles -->
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />

    <!-- Custom CineScope Styles -->
    <link href="css/cinescope.css" rel="stylesheet" />
    <link href="css/poster-cache.css" rel="stylesheet" />

    <!-- reCAPTCHA Script -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
    <script>
        function onRecaptchaLoad() {
            console.log("reCAPTCHA loaded");
        }
        
        window.recaptchaFunctions = {
            widgets: {},
            render: function (elementId) {
                console.log("Attempting to render reCAPTCHA v2 for", elementId);
                
                const renderWidget = () => {
                    try {
                        if (typeof grecaptcha === 'undefined') {
                            console.log("reCAPTCHA not loaded yet, retrying in 500ms...");
                            setTimeout(() => renderWidget(), 500);
                            return;
                        }

                        const element = document.getElementById(elementId);
                        if (!element) {
                            console.log("Element not found, retrying in 500ms...");
                            setTimeout(() => renderWidget(), 500);
                            return;
                        }

                        console.log("Found element, rendering reCAPTCHA...");
                        const widgetId = grecaptcha.render(elementId, {
                            'sitekey': '6Ld8oAYrAAAAAKxRXwgV4_1PMHv06IudnMlG1_Uh',
                            'size': 'normal',
                            'theme': 'dark',
                            'badge': 'inline',
                            'callback': (token) => {
                                console.log("reCAPTCHA callback received token");
                                this.widgets[elementId] = {
                                    widgetId: widgetId,
                                    token: token
                                };
                            }
                        });
                        this.widgets[elementId] = { widgetId: widgetId, token: null };
                        console.log("reCAPTCHA rendered successfully");
                    } catch (e) {
                        console.error("Error rendering reCAPTCHA:", e);
                        setTimeout(() => renderWidget(), 500);
                    }
                };

                renderWidget();
            },
            executeRecaptcha: async function (elementId) {
                console.log("Getting reCAPTCHA token for", elementId || "default widget");
                if (elementId && this.widgets[elementId]) {
                    return this.widgets[elementId].token;
                }
                // For backward compatibility with existing code
                return this.widgets['recaptcha-container']?.token;
            },
            reset: function (elementId) {
                console.log("Resetting reCAPTCHA for", elementId || "all widgets");
                try {
                    if (elementId && this.widgets[elementId]) {
                        grecaptcha.reset(this.widgets[elementId].widgetId);
                        this.widgets[elementId].token = null;
                    } else {
                        // Reset all widgets
                        Object.values(this.widgets).forEach(widget => {
                            grecaptcha.reset(widget.widgetId);
                            widget.token = null;
                        });
                    }
                } catch (e) {
                    console.error("Error resetting reCAPTCHA:", e);
                }
            }
        };
    </script>

    <!-- Window resize handling -->
    <script>
        window.addResizeEventListener = function (dotnetHelper) {
            window._dotnetHelper = dotnetHelper;
            window.onresize = debounce(async function () {
                await window._dotnetHelper.invokeMethodAsync('OnWindowResize');
            }, 250);
        };

        window.removeResizeEventListener = function () {
            window.onresize = null;
            window._dotnetHelper = null;
        };

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>

</head>

<body>
    <!-- Application Root -->
    <div id="app">
        <!-- Loading Screen -->
        <div class="loading-progress-text">
            <div style="text-align: center; padding-top: 100px;">
                <h1 style="color: #E50914;">CineScope</h1>
                <p>Loading your cinematic experience...</p>
                <div class="mud-progress-circular mud-default-text" role="progressbar" style="height: 40px; width: 40px; margin: 20px auto;">
                    <svg class="mud-progress-circular-svg" viewBox="22 22 44 44">
                        <circle class="mud-progress-circular-circle-indeterminate" cx="44" cy="44" r="20" fill="none" stroke-width="3"></circle>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
</body>
</html>
